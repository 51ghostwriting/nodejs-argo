name: Build and Push Docker Image

on:
  push:
    branches: [ main ]
    paths:
      - 'Dockerfile'
      - 'index.js'
      - 'package.json'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate random image name
        run: |
          # 6-8位英文单词列表
          NAMES=("alpine" "bamboo" "canyon" "falcon" "glacier" "harbor" "island" "jungle" "kernel" "lagoon" "meadow" "nebula" "phoenix" "quartz" "summit" "thunder" "valley" "willow" "aurora" "breeze" "ember" "frost" "horizon" "ivory" "lotus" "maple" "oasis" "pearl" "storm" "vortex" "zephyr" "comet" "flare" "prism" "spark" "blaze" "cloud" "flame" "lunar" "crystal" "shadow" "silver" "golden" "cosmic" "stellar" "orbital" "quantum" "plasma" "photon")
          
          # 使用更好的随机源
          RAND1=$(od -An -tu4 -N4 /dev/urandom | tr -d ' ')
          RAND2=$(od -An -tu4 -N4 /dev/urandom | tr -d ' ')
          
          # 随机选择名称
          NAME=${NAMES[$((RAND1 % ${#NAMES[@]}))]}
          
          # 生成5位随机数字作为 tag
          RANDOM_TAG=$(printf "%05d" $((RAND2 % 100000)))
          
          # 镜像名称和tag分开: name:12345
          echo "Generated image: $NAME:$RANDOM_TAG"
          echo "DOCKER_IMAGE_NAME=$NAME" >> $GITHUB_ENV
          echo "DOCKER_IMAGE_TAG=$RANDOM_TAG" >> $GITHUB_ENV

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate UUID and Obfuscate code
        run: |
          # 生成新的 UUID
          NEW_UUID=$(cat /proc/sys/kernel/random/uuid)
          echo "Generated UUID: $NEW_UUID"
          
          # 替换 index.js 中的默认 UUID
          sed -i "s/const UUID = process.env.UUID || '[^']*'/const UUID = process.env.UUID || '$NEW_UUID'/" index.js
          
          # 安装混淆工具
          npm install javascript-obfuscator -g
          
          # 混淆 index.js (medium-obfuscation preset)
          javascript-obfuscator index.js \
            --output index.js \
            --options-preset medium-obfuscation
          
          echo "Code obfuscation completed"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}
          labels: |
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.description=HTTP Server
            org.opencontainers.image.licenses=MIT
          cache-from: type=gha
          cache-to: type=gha,mode=max
